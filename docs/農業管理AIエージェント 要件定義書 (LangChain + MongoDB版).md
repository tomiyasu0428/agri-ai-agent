## 【Step 1】 Why：この機能を開発する目的と背景

- **1-1. 解決したいユーザー課題 (User Problem / Pain):**
    - **誰が (Who):** ダチョウファームの農作業員（特に経験の浅い新人）、および農場管理者。
    - **どんな状況で (When/Where):** 日々の作業計画を立てる時、現場で作業内容を確認する時、特に「どの畑の」「どの作物に」「いつ、どの農薬を散布すべきか」といった専門的な判断が求められる時。
    - **何を解決したいか (What):** 思考のプロセスそのものをなくしたい。紙や個人の記憶、経験と勘に頼った属人的な農業から脱却したい。特に、畑・作物・天候・時期によって最適な農薬や作業を都度考えるのが大きな精神的・時間的負担となっている。使い慣れたLINEでAIに相談すれば、熟練者のように具体的な次の一手を指示してくれる、そんな未来を実現したい。
- **1-2. 解決したいビジネス課題 (Business Problem / Gain):**
    - **生産性の向上:** 作業判断の時間をゼロにし、作業員の稼働率を最大化する。
    - **品質の安定化:** AIによる標準化された最適な作業提案により、作業員のスキルレベルに関わらず、農作物の品質を安定・向上させる。
    - **コスト削減:** 農薬や肥料の過不足ない使用、作業ミスの削減により、資材コストと損失を低減する。
    - **技術伝承と人材育成:** AIが熟練者の知識を学習・提供することで、新人でも即戦力として活躍できるようになり、教育コストを削減する。
- **1-3. 開発のゴール (Project Goal) & 成功指標 (Success Metrics):**
    - **定性ゴール:** 作業員が、圃場のどこにいても、スマホ一つで「次に何をすべきか」の具体的な指示を受け取り、思考の負荷なく、自信を持って作業に集中できるようになる。
    - **定量ゴール (KPI):**
        - 農薬選定にかかる時間が平均10分から0分になる（AIの提案を信頼して採用）。
        - 新人作業員が一人で判断に迷う時間が週平均60分から5分未満に短縮される。
        - LINE経由でのタスク実行率が95%以上を維持する。
        - AIの応答時間を3秒以内に短縮（MongoDB高速検索による）。
- **1-4. スコープ (Scope):**
    - **やること (In Scope):**
        - **フェーズ1:** MongoDBのデータを参照し、「今日のタスク」などを自然言語で応答する基本的なエージェントの構築。
        - **フェーズ2:** 圃場・作物・天候などの情報から、AIが最適な農薬や作業を判断し、自然言語で提案する機能の実装。
        - **フェーズ3:** LINE上での双方向のタスク管理（完了報告、自動スケジュール更新）。
    - **やらないこと (Out of Scope):**
        - リアルタイムの画像認識による病害虫診断（将来展望）。
        - サプライヤーへの資材自動発注機能。

---

## 【Step 2】 How：どうやって目的を実現するのか（仕様・設計）

- **2-1. ユーザーストーリー (User Stories):**
    - `新人作業員として、農薬の選択で絶対に間違えたくないので、「A畑のトマト、次の作業は？」と聞くと、AIが「病害虫Xの予防のため、農薬YをZ倍希釈で散布してください」と具体的に指示してくれる。`
    - `作業員として、「今日の消毒作業終わりました」とLINEで報告すると、AIが該当タスクを自動で完了にし、7日後の次回防除を自動スケジュールしてくれる。`
    - `農場管理者として、「来週の作業予定は？」と聞くと、全圃場の作業計画が一覧で表示され、リソース配分を効率的に判断できる。`
- **2-2. ビジネスルール (Business Rules):**
    - AIの提案は、MongoDB上の「作物マスター」「農薬マスター」「作業履歴」のデータを正とする。
    - 既存Airtableのスキーマ定義、フィールド設定、全記入内容を完全にMongoDB形式に移行・保持する。
    - 農薬の提案ロジックは、過去の散布履歴（ローテーション防除）と天候データを考慮する。
    - 防除作業完了時は、自動的に7日後（設定可能）の次回防除をスケジュールする。
    - 全ての作業指示と完了報告は、MongoDB上にログとして記録される。
- **2-3. 機能要件 (Functional Requirements):**
    - **[F-01] データ参照:** LangChainエージェントはMongoDB上のデータを高速で読み取ることができる。
    - **[F-02] データ作成:** エージェントはMongoDBに新しいドキュメント（作業ログ等）を作成できる。
    - **[F-03] データ更新:** エージェントはMongoDBの既存ドキュメントを更新できる。
    - **[F-04] 自動スケジューリング:**
        - **[F-04-01] 自動タスク生成:** 作業完了時に次回タスクを自動生成する。
        - **[F-04-02] 今日のタスク通知:** 毎朝、作業タスクを対象者にLINEで通知する。
    - **[F-05] 自然言語処理:**
        - **[F-05-01] 自然言語での問い合わせ:** 「今日のタスクは？」「防除の進捗は？」等の質問に回答する。
        - **[F-05-02] 自然言語での作業報告:** 「消毒作業終わりました」等の報告を自動でデータ更新に変換する。
    - **[F-06] AI提案:**
        - **[F-06-01] 農作業提案:** 圃場、作物、天候、生育ステージに基づき、次に実施すべき最適な作業を判断・提案する。
        - **[F-06-02] 農薬ローテーション提案:** 過去の使用履歴から最適な農薬を自動選定する。
    - **[F-07] ユーザー認証:** LINEアカウントとMongoDBの「作業者マスター」を紐付ける。
    - **[F-08] リアルタイム通知:** MongoDBのChange Streamsを使用したリアルタイム更新通知。
    - **[F-09] リッチメニュー:** よく使う機能をLINEのリッチメニューに配置する。
- **2-4. 非機能要件 (Non-Functional Requirements):**
    - **[NF-01] セキュリティ:** APIキーや接続情報はGoogle Secret Manager等で安全に管理する。
    - **[NF-02] パフォーマンス:** ユーザーからの問い合わせに対し、3秒以内に応答を返す（MongoDB高速検索）。
    - **[NF-03] 可用性:** システムは24時間365日稼働を目指す（MongoDB Atlas冗長化）。
    - **[NF-04] スケーラビリティ:** 農場規模拡大に応じてデータ量とアクセス数が増加しても対応可能。

---

## 【Step 3】 What：具体的に、何を作り、どう進めるのか（タスク・実装）

- **3-1. 主要な成果物 (Key Deliverables):**
    - LangChainで構築されたAIエージェントのソースコード。
    - MongoDB操作、農薬選定ロジック等を実装したLangChainツールのソースコード。
    - Google Cloud Functions上で動作するLINE Webhook用関数。
    - MongoDBデータベース設計ドキュメント。
    - GitHubリポジトリでのソースコード管理。
- **3-2. 実装タスクの内訳 (Task Breakdown / Epics):**
    - **フェーズ1: 基盤構築:** LangChain環境セットアップ、MongoDB接続、Airtableスキーマ・データ完全移行、基本エージェントの構築。
    - **フェーズ2: インテリジェント機能開発:** 農薬提案システム、自動スケジューリング、LINE連携の実装。
    - **フェーズ3: 本番化・運用:** デプロイ、モニタリング体制の構築、継続的改善。
- **3-3. 開発マイルストーン (Development Milestones):**
    - **Sprint 1-2:** フェーズ1完了。ローカル環境でMongoDB連携エージェントが動作する。
    - **Sprint 3-4:** フェーズ2完了。LINE上でAIが自然言語で農薬提案・作業管理を行えるプロトタイプが完成。
    - **Sprint 5:** フェーズ3着手。Cloud Runへデプロイし、一部ユーザーによるUAT（ユーザー受け入れテスト）を開始。
- **3-4. 技術スタック・アーキテクチャ方針 (Tech Stack / Architecture):**
    - **言語:** Python 3.9+
    - **AIエージェント:** LangChain (Agent + Tools)
    - **LLM:** OpenAI GPT-4 または Anthropic Claude
    - **データベース:** MongoDB Atlas (NoSQL)
    - **インフラ:** Google Cloud Functions (Webhook), Google Cloud Run (エージェント実行環境)
    - **UI:** LINE Messaging API
    - **ソースコード管理:** Git / GitHub
    - **秘密管理:** Google Secret Manager
    - **監視:** Google Cloud Monitoring + MongoDB Atlas監視
- **3-5. データベース設計方針:**
    - **ドキュメント指向設計:** 圃場ごとに関連情報を統合したドキュメント構造
    - **埋め込み優先:** 関連データはサブドキュメントとして埋め込み、JOIN操作を最小化
    - **時系列データ対応:** 作業履歴、センサーデータの効率的な格納
    - **Change Streams活用:** リアルタイム更新の自動処理