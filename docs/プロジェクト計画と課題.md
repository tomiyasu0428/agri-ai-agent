# プロジェクト計画と課題

**更新日時:** 2025年7月10日
**プロジェクトビジョン:** 「考えるプロセスをなくし、AIが次の一手を指南する」

---

## 1. 全体進捗概要

- **フェーズ1 (基盤構築):** 🟢 **95%完了** - ほぼ完成
- **フェーズ2 (インテリジェント機能):** 🟢 **85%完了** - NLP機能の完成
- **フェーズ3 (本番化・運用):** 🔴 **0%完了** - 未着手

### 全体進捗: **80%完了**

---

## 2. 完了済みタスクリスト

### フェーズ1: 基盤構築 (LangChain + MongoDB)
- ✅ **T-01: 開発環境セットアップ**
- ✅ **T-02: MongoDB データベース設計・構築** (Airtableから11テーブル、427レコードの移行完了)
- ✅ **T-03: LangChain基本エージェント構築**

### フェーズ2: インテリジェント機能開発
- ✅ **T-04: 農場管理特化ツールの開発** (`get_today_tasks`, `complete_task` など5ツール)
- ✅ **T-05: 自然言語処理機能の強化** (`report_parser`, `context_manager` など4機能)

--- 

## 3. 現状の課題と次のタスク

### 🎯 最優先タスク: T-07 LINE連携の実装

LINE Botを実際に動かすための実装を最優先で進めます。

- **T-07-01: LINE Messaging API Webhook設定**
  - **課題:** ngrok URL更新時の手動作業、APIのタイムアウト。
  - **タスク:** ngrok自動更新スクリプトを検討しつつ、まずは安定したWebhook接続を確立する。
- **T-07-02: LINEユーザー認証とMongoDB紐付け**
  - **タスク:** LINEのUserIDと作業者マスターを連携させ、ユーザーごとの応答を可能にする。
- **T-07-03: リッチメニュー実装**
  - **タスク:** よく使う機能をLINEのリッチメニューから呼び出せるようにする。

### 課題エリア1: データスキーマ（MongoDB）

- **現状の課題:**
  - Airtable由来の日本語キーが冗長で、クエリが複雑化・低速化している (`$lookup` 多用)。
  - 時系列データ（作業履歴）の集計が困難。
- **次のタスク:**
  1. フィールド名を「英語・snake_case」に統一するリファクタリング。
  2. 時系列ログを扱う`work_logs`コレクションを新設する。
  3. クエリを高速化するため、非正規化した`field_summary`キャッシュ用コレクションを検討する。
  4. 代表的な質問パターンを洗い出し、最適なインデックスを設計する。

### 課題エリア2: ツール／エージェント設計

- **現状の課題:**
  - 単一エージェントが読み取り・書き込み両方のツールを持ち、誤操作のリスクがある。
  - LLMが生成する引数が複雑になりがち。
- **次のタスク:**
  1. **エージェントの二分化:** ReadOnlyAgent（情報取得系）とWriteAgent（更新系）に分離する。
  2. **意図分類:** MessageHandlerにキーワードベースの意図分類を追加し、適切なエージェントを呼び出す。
  3. **専用ツールの追加:** `get_recent_spray(field_id)` のように、より具体的なツールを増やす。

### 課題エリア3: パフォーマンスと運用

- **現状の課題:**
  - 複雑な集計処理（`$aggregate`）で応答が遅延することがある。
- **次のタスク:**
  1. DatabasePoolのキャッシュ戦略をチューニングする。
  2. 非同期クエリ（`asyncio.gather`）を並列化し、応答速度を改善する。
  3. LLMのタイムアウト時に備え、リトライやフォールバック処理を実装する。

### 課題エリア4: テスト・QA

- **次のタスク:**
  1. **単体テスト:** ツールごとの正答率と副作用を確認する。
  2. **E2Eテスト:** 代表的なシナリオでの応答時間を計測する。
  3. **負荷試験:** 複数ユーザーの同時アクセス時の安定性を確認する。

---

## 4. 技術スタックとマイルストーン

- **言語:** Python 3.9+
- **AIエージェント:** LangChain (Agent + Tools)
- **LLM:** Google Gemini 2.5 Flash (models/gemini-2.5-flash)
- **データベース:** MongoDB Atlas (NoSQL)
- **インフラ:** Google Cloud Functions (Webhook), Google Cloud Run (エージェント実行環境)
- **UI:** LINE Messaging API

### 次のマイルストーン

**目標:** 2025年7月末までにLINE連携を完了させ、実際の農場での試験運用を開始する。

**成功指標:** 
- 作業員がLINEで「今日のタスクは？」と質問し、AIが具体的な回答を返す。
- 「防除完了」の報告で自動的に次回スケジュールが生成される。
- 実際の農場データに基づいた農薬推奨が動作する。
